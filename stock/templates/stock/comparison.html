<!-- stock/templates/stock/comparison.html - ÈäòÊüÑÊØîËºÉ„Éö„Éº„Ç∏ -->
{% extends 'stock/base.html' %}
{% load stock_filters %}

{% block title %}ÈäòÊüÑÊØîËºÉÂàÜÊûê - Ê†™ÂºèÂàÜÊûê{% endblock %}

{% block extra_css %}
<style>
    .comparison-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .stock-card {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
    }
    
    .stock-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
    }
    
    .stock-card.highlight {
        border-left-color: #28a745;
        background: linear-gradient(135deg, #f8fff9, #ffffff);
    }
    
    .stock-basic-info {
        text-align: center;
        padding: 20px;
        background: linear-gradient(135deg, #f8f9fa, #ffffff);
        border-radius: 12px;
        margin-bottom: 20px;
    }
    
    .stock-code {
        font-size: 2rem;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 8px;
    }
    
    .stock-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
    }
    
    .stock-sector {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 15px;
    }
    
    .price-display {
        font-size: 1.8rem;
        font-weight: bold;
        color: #28a745;
        margin-top: 10px;
    }
    
    .comparison-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        margin-bottom: 25px;
    }
    
    .comparison-table-header {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding: 15px 20px;
    }
    
    .comparison-table table {
        margin: 0;
        font-size: 0.9rem;
    }
    
    .comparison-table th {
        background: #f8f9fa;
        font-weight: 600;
        padding: 12px 10px;
        border: none;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .comparison-table td {
        padding: 10px;
        border-color: #f1f3f4;
        vertical-align: middle;
    }
    
    .metric-row:nth-child(even) {
        background: rgba(102, 126, 234, 0.02);
    }
    
    .metric-label {
        font-weight: 600;
        color: #495057;
        background: #f8f9fa;
        padding: 12px 15px;
        border-right: 2px solid #e9ecef;
    }
    
    .metric-value {
        text-align: center;
        font-weight: 600;
        padding: 12px;
    }
    
    .best-value {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        color: #155724;
        font-weight: bold;
        position: relative;
    }
    
    .best-value::before {
        content: 'üëë';
        position: absolute;
        top: 2px;
        right: 2px;
        font-size: 0.7rem;
    }
    
    .worst-value {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
    }
    
    .chart-container {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        height: 400px;
    }
    
    .chart-tabs {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        border-bottom: 2px solid #e9ecef;
    }
    
    .chart-tab {
        padding: 10px 20px;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #6c757d;
        transition: all 0.3s ease;
    }
    
    .chart-tab:hover {
        color: #495057;
        background: #f8f9fa;
    }
    
    .chart-tab.active {
        color: #667eea;
        border-bottom-color: #667eea;
        background: linear-gradient(135deg, #f8f9ff, #ffffff);
    }
    
    .score-comparison {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .score-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 12px 0;
        border-bottom: 1px solid #f1f3f4;
    }
    
    .score-item:last-child {
        border-bottom: none;
    }
    
    .score-label {
        font-weight: 600;
        color: #495057;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .score-bars {
        display: flex;
        gap: 8px;
        flex: 1;
        margin: 0 20px;
    }
    
    .score-bar {
        height: 25px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.8rem;
        min-width: 60px;
        position: relative;
        overflow: hidden;
    }
    
    .score-excellent { background: linear-gradient(135deg, #28a745, #20c997); }
    .score-good { background: linear-gradient(135deg, #007bff, #17a2b8); }
    .score-average { background: linear-gradient(135deg, #ffc107, #fd7e14); }
    .score-poor { background: linear-gradient(135deg, #dc3545, #e83e8c); }
    
    .financial-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 25px;
    }
    
    .financial-card {
        background: white;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
    }
    
    .financial-card h6 {
        color: #667eea;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }
    
    .metric-comparison-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid #f8f9fa;
    }
    
    .metric-comparison-row:last-child {
        border-bottom: none;
    }
    
    .metric-name {
        font-weight: 600;
        color: #495057;
        flex: 1;
    }
    
    .metric-values {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .metric-value-item {
        text-align: center;
        min-width: 80px;
    }
    
    .metric-value-number {
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .metric-value-label {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 2px;
    }
    
    .winner-indicator {
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
    }
    
    .analysis-summary {
        background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 25px;
    }
    
    .analysis-summary h5 {
        color: #1976d2;
        margin-bottom: 15px;
    }
    
    .recommendation-card {
        background: white;
        border-left: 4px solid #28a745;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }
    
    .recommendation-card.warning {
        border-left-color: #ffc107;
        background: #fff9e6;
    }
    
    .recommendation-card.danger {
        border-left-color: #dc3545;
        background: #fdf2f2;
    }
    
    .export-controls {
        background: white;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        text-align: center;
    }
    
    .chart-legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }
    
    .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 4px;
    }
    
    /* „É¨„Çπ„Éù„É≥„Ç∑„ÉñÂØæÂøú */
    @media (max-width: 768px) {
        .stock-card {
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .stock-code {
            font-size: 1.5rem;
        }
        
        .stock-name {
            font-size: 1rem;
        }
        
        .price-display {
            font-size: 1.4rem;
        }
        
        .comparison-table th,
        .comparison-table td {
            padding: 8px 6px;
            font-size: 0.8rem;
        }
        
        .score-bars {
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }
        
        .metric-values {
            flex-direction: column;
            gap: 8px;
        }
        
        .chart-container {
            height: 300px;
            padding: 15px;
        }
        
        .financial-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .stock-column {
        width: auto;
    }
    
    /* ÈäòÊüÑÊï∞„Å´Âøú„Åò„ÅüÂãïÁöÑÂπÖË™øÊï¥ */
    .comparison-table table {
        table-layout: fixed;
        width: 100%;
    }
    
    .comparison-table tbody tr td:first-child,
    .comparison-table thead tr th:first-child {
        width: 20%;
        min-width: 150px;
    }
    
    /* 2ÈäòÊüÑÊØîËºÉ */
    [data-stock-count="2"] .stock-column {
        width: 40%;
    }
    
    /* 3ÈäòÊüÑÊØîËºÉ */
    [data-stock-count="3"] .stock-column {
        width: 26.67%;
    }
    
    /* 4ÈäòÊüÑÊØîËºÉ */
    [data-stock-count="4"] .stock-column {
        width: 20%;
    }
    
    /* 5ÈäòÊüÑ‰ª•‰∏ä */
    [data-stock-count="5"] .stock-column,
    [data-stock-count="6"] .stock-column,
    [data-stock-count="7"] .stock-column,
    [data-stock-count="8"] .stock-column,
    [data-stock-count="9"] .stock-column,
    [data-stock-count="10"] .stock-column {
        width: 16%;
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 12px;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .financial-trend-chart {
        height: 300px;
        margin: 15px 0;
    }

    .comparative-metric {
        position: relative;
        overflow: hidden;
    }

    .metric-progress {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        margin-top: 5px;
        overflow: hidden;
    }

    .metric-progress-bar {
        height: 100%;
        border-radius: 4px;
        transition: width 0.3s ease;
    }

    .add-stock-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }

    .add-stock-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .remove-stock-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: all 0.3s ease;
    }

    .stock-card:hover .remove-stock-btn {
        opacity: 1;
    }

    .remove-stock-btn:hover {
        background: #c82333;
        transform: scale(1.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- ÊØîËºÉ„Éò„ÉÉ„ÉÄ„Éº -->
    <div class="comparison-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h2 class="mb-3">
                    <i class="fas fa-balance-scale me-2"></i>
                    ÈäòÊüÑÊØîËºÉÂàÜÊûê
                </h2>
                <p class="mb-0 opacity-75">
                    <i class="fas fa-chart-line me-1"></i>
                    ÈÅ∏ÊäûÈäòÊüÑ: <span id="selected-count">{{ stocks|length }}</span>ÈäòÊüÑ
                    <span class="ms-3">
                        <i class="fas fa-clock me-1"></i>
                        ÊúÄÁµÇÊõ¥Êñ∞: <span id="last-update">{{ last_update|default:"ÂèñÂæó‰∏≠..." }}</span>
                    </span>
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="d-flex justify-content-end gap-2">
                    <button class="btn btn-outline-light btn-sm add-stock-btn" onclick="addStockToComparison()">
                        <i class="fas fa-plus me-1"></i>ÈäòÊüÑËøΩÂä†
                    </button>
                    <button class="btn btn-outline-light btn-sm" onclick="refreshComparison()">
                        <i class="fas fa-sync-alt me-1"></i>Êõ¥Êñ∞
                    </button>
                    <a href="{% url 'stock:screening' %}" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-arrow-left me-1"></i>Êàª„Çã
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈäòÊüÑ„Ç´„Éº„Éâ‰∏ÄË¶ß -->
    <div class="row" id="stock-cards-container">
        {% for stock_data in stocks %}
        <div class="col-xl-3 col-lg-4 col-md-6 mb-4" data-stock-code="{{ stock_data.stock.code }}">
            <div class="stock-card {% if forloop.first %}highlight{% endif %}">
                <button class="remove-stock-btn" onclick="removeStockFromComparison('{{ stock_data.stock.code }}')">
                    <i class="fas fa-times"></i>
                </button>
                
                <div class="stock-basic-info">
                    <div class="stock-code">{{ stock_data.stock.code }}</div>
                    <div class="stock-name">{{ stock_data.stock.name }}</div>
                    <div class="stock-sector">{{ stock_data.stock.sector|default:"-" }}</div>
                    <div class="price-display">
                        {% if stock_data.indicator.price %}
                        ¬•{{ stock_data.indicator.price|floatformat:0 }}
                        {% else %}
                        -
                        {% endif %}
                    </div>
                    {% if stock_data.stock.market %}
                    <span class="badge bg-primary mt-2">{{ stock_data.stock.market }}</span>
                    {% endif %}
                </div>
                
                <!-- „ÇØ„Ç§„ÉÉ„ÇØÊåáÊ®ô -->
                <div class="mt-3">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="small text-muted">PER</div>
                            <div class="fw-bold {% if stock_data.indicator.per %}{% if stock_data.indicator.per < 15 %}text-success{% elif stock_data.indicator.per > 25 %}text-danger{% endif %}{% endif %}">
                                {{ stock_data.indicator.per|floatformat:1|default:"-" }}
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="small text-muted">PBR</div>
                            <div class="fw-bold {% if stock_data.indicator.pbr %}{% if stock_data.indicator.pbr < 1.5 %}text-success{% elif stock_data.indicator.pbr > 3 %}text-danger{% endif %}{% endif %}">
                                {{ stock_data.indicator.pbr|floatformat:2|default:"-" }}
                            </div>
                        </div>
                    </div>
                    <div class="row text-center mt-2">
                        <div class="col-6">
                            <div class="small text-muted">ROE</div>
                            <div class="fw-bold {% if stock_data.roe %}{% if stock_data.roe > 15 %}text-success{% elif stock_data.roe < 5 %}text-danger{% endif %}{% endif %}">
                                {{ stock_data.roe|floatformat:1|default:"-" }}%
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="small text-muted">ÈÖçÂΩì</div>
                            <div class="fw-bold {% if stock_data.indicator.dividend_yield %}{% if stock_data.indicator.dividend_yield > 3 %}text-success{% endif %}{% endif %}">
                                {{ stock_data.indicator.dividend_yield|floatformat:2|default:"-" }}%
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Á∑èÂêà„Çπ„Ç≥„Ç¢ -->
                <div class="mt-3 text-center">
                    <div class="small text-muted mb-2">Á∑èÂêà„Çπ„Ç≥„Ç¢</div>
                    <div class="score-badge {% if stock_data.total_score > 80 %}score-excellent{% elif stock_data.total_score > 60 %}score-good{% elif stock_data.total_score > 40 %}score-average{% else %}score-poor{% endif %}" 
                         style="font-size: 1.2rem; padding: 8px 16px;">
                        {{ stock_data.total_score }}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Ë©≥Á¥∞ÊØîËºÉ„ÉÜ„Éº„Éñ„É´ -->
    <div class="comparison-table" data-stock-count="{{ stocks|length }}">
        <div class="comparison-table-header">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>
                Ë©≥Á¥∞ÊåáÊ®ôÊØîËºÉ
            </h5>
        </div>
        <div class="table-responsive">
            <table class="table mb-0">
                <thead>
                    <tr>
                        <th width="20%">ÊåáÊ®ô</th>
                        {% for stock_data in stocks %}
                        <th class="text-center stock-column">
                            <div class="fw-bold">{{ stock_data.stock.code }}</div>
                            <small class="text-muted">{{ stock_data.stock.name|truncatechars:15 }}</small>
                        </th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    <!-- „Éê„É™„É•„Ç®„Éº„Ç∑„Éß„É≥ÊåáÊ®ô -->
                    <tr class="metric-row">
                        <td class="metric-label">
                            <i class="fas fa-chart-bar text-primary me-2"></i>
                            PERÔºàÊ†™‰æ°ÂèéÁõäÁéáÔºâ
                        </td>
                        {% for stock_data in stocks %}
                        <td class="metric-value {% if stock_data.is_best_per %}best-value{% elif stock_data.is_worst_per %}worst-value{% endif %}">
                            {{ stock_data.indicator.per|floatformat:1|default:"-" }}
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="metric-row">
                        <td class="metric-label">
                            <i class="fas fa-chart-area text-info me-2"></i>
                            PBRÔºàÊ†™‰æ°Á¥îË≥áÁî£ÂÄçÁéáÔºâ
                        </td>
                        {% for stock_data in stocks %}
                        <td class="metric-value {% if stock_data.is_best_pbr %}best-value{% elif stock_data.is_worst_pbr %}worst-value{% endif %}">
                            {{ stock_data.indicator.pbr|floatformat:2|default:"-" }}
                        </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- ÂèéÁõäÊÄßÊåáÊ®ô -->
                    <tr class="metric-row">
                        <td class="metric-label">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            ROEÔºàËá™Â∑±Ë≥áÊú¨Âà©ÁõäÁéáÔºâ%
                        </td>
                        {% for stock_data in stocks %}
                        <td class="metric-value {% if stock_data.is_best_roe %}best-value{% elif stock_data.is_worst_roe %}worst-value{% endif %}">
                            {{ stock_data.roe|floatformat:1|default:"-" }}%
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="metric-row">
                        <td class="metric-label">
                            <i class="fas fa-chart-pie text-warning me-2"></i>
                            ROAÔºàÁ∑èË≥áÁî£Âà©ÁõäÁéáÔºâ%
                        </td>
                        {% for stock_data in stocks %}
                        <td class="metric-value {% if stock_data.is_best_roa %}best-value{% elif stock_data.is_worst_roa %}worst-value{% endif %}">
                            {{ stock_data.roa|floatformat:1|default:"-" }}%
                        </td>
                        {% endfor %}
                    </tr>
                    
                    <!-- ÈÖçÂΩì„Éª„Åù„ÅÆ‰ªñ -->
                    <tr class="metric-row">
                        <td class="metric-label">
                            <i class="fas fa-coins text-warning me-2"></i>
                            ÈÖçÂΩìÂà©Âõû„Çä %
                        </td>
                        {% for stock_data in stocks %}
                        <td class="metric-value {% if stock_data.is_best_dividend %}best-value{% elif stock_data.is_worst_dividend %}worst-value{% endif %}">
                            {{ stock_data.indicator.dividend_yield|floatformat:2|default:"-" }}%
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="metric-row">
                        <td class="metric-label">
                            <i class="fas fa-yen-sign text-success me-2"></i>
                            Ê†™‰æ° (ÂÜÜ)
                        </td>
                        {% for stock_data in stocks %}
                        <td class="metric-value">
                            <strong>{{ stock_data.indicator.price|floatformat:0|default:"-" }}</strong>
                        </td>
                        {% endfor %}
                    </tr>
                    <tr class="metric-row">
                        <td class="metric-label">
                            <i class="fas fa-building text-info me-2"></i>
                            ÊôÇ‰æ°Á∑èÈ°ç (ÂÑÑÂÜÜ)
                        </td>
                        {% for stock_data in stocks %}
                        <td class="metric-value">
                            {% if stock_data.indicator.market_cap %}
                            {{ stock_data.indicator.market_cap|floatformat:0 }}
                            {% else %}
                            -
                            {% endif %}
                        </td>
                        {% endfor %}
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- „Çπ„Ç≥„Ç¢ÊØîËºÉË¶ñË¶öÂåñ -->
    <div class="score-comparison">
        <h5 class="mb-4">
            <i class="fas fa-trophy text-warning me-2"></i>
            Á∑èÂêà„Çπ„Ç≥„Ç¢ÊØîËºÉ
        </h5>
        
        <div class="score-item">
            <div class="score-label">
                <i class="fas fa-chart-bar text-primary"></i>
                „Éê„É™„É•„Ç®„Éº„Ç∑„Éß„É≥
            </div>
            <div class="score-bars">
                {% for stock_data in stocks %}
                <div class="score-bar {% if stock_data.valuation_score > 20 %}score-excellent{% elif stock_data.valuation_score > 15 %}score-good{% elif stock_data.valuation_score > 8 %}score-average{% else %}score-poor{% endif %}"
                     style="width: {{ stock_data.valuation_score|floatformat:0 }}%">
                    {{ stock_data.stock.code }}: {{ stock_data.valuation_score }}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="score-item">
            <div class="score-label">
                <i class="fas fa-chart-line text-success"></i>
                ÂèéÁõäÊÄß
            </div>
            <div class="score-bars">
                {% for stock_data in stocks %}
                <div class="score-bar {% if stock_data.profitability_score > 20 %}score-excellent{% elif stock_data.profitability_score > 15 %}score-good{% elif stock_data.profitability_score > 8 %}score-average{% else %}score-poor{% endif %}"
                     style="width: {{ stock_data.profitability_score|floatformat:0 }}%">
                    {{ stock_data.stock.code }}: {{ stock_data.profitability_score }}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="score-item">
            <div class="score-label">
                <i class="fas fa-trending-up text-info"></i>
                ÊàêÈï∑ÊÄß
            </div>
            <div class="score-bars">
                {% for stock_data in stocks %}
                <div class="score-bar {% if stock_data.growth_score > 20 %}score-excellent{% elif stock_data.growth_score > 15 %}score-good{% elif stock_data.growth_score > 8 %}score-average{% else %}score-poor{% endif %}"
                     style="width: {{ stock_data.growth_score|floatformat:0 }}%">
                    {{ stock_data.stock.code }}: {{ stock_data.growth_score }}
                </div>
                {% endfor %}
            </div>
        </div>
        
        <div class="score-item">
            <div class="score-label">
                <i class="fas fa-shield-alt text-warning"></i>
                ÂÆâÂÖ®ÊÄß
            </div>
            <div class="score-bars">
                {% for stock_data in stocks %}
                <div class="score-bar {% if stock_data.safety_score > 20 %}score-excellent{% elif stock_data.safety_score > 15 %}score-good{% elif stock_data.safety_score > 8 %}score-average{% else %}score-poor{% endif %}"
                     style="width: {{ stock_data.safety_score|floatformat:0 }}%">
                    {{ stock_data.stock.code }}: {{ stock_data.safety_score }}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- „ÉÅ„É£„Éº„ÉàÊØîËºÉ -->
    <div class="chart-container">
        <div class="chart-tabs">
            <button class="chart-tab active" onclick="switchChart('performance')">
                <i class="fas fa-chart-line me-1"></i>
                „Éë„Éï„Ç©„Éº„Éû„É≥„ÇπÊØîËºÉ
            </button>
            <button class="chart-tab" onclick="switchChart('valuation')">
                <i class="fas fa-chart-bar me-1"></i>
                „Éê„É™„É•„Ç®„Éº„Ç∑„Éß„É≥
            </button>
            <button class="chart-tab" onclick="switchChart('profitability')">
                <i class="fas fa-chart-area me-1"></i>
                ÂèéÁõäÊÄßÊØîËºÉ
            </button>
            <button class="chart-tab" onclick="switchChart('radar')">
                <i class="fas fa-bullseye me-1"></i>
                „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà
            </button>
        </div>
        
        <div id="chart-loading" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
        </div>
        
        <canvas id="comparison-chart" height="300"></canvas>
        
        <div class="chart-legend" id="chart-legend">
            {% for stock_data in stocks %}
            <div class="legend-item">
                <div class="legend-color" style="background: {{ stock_data.color|default:'#667eea' }};"></div>
                <span>{{ stock_data.stock.code }} - {{ stock_data.stock.name|truncatechars:20 }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Ë≤°Âãô„Éá„Éº„ÇøÊØîËºÉ -->
    <div class="financial-grid">
        <!-- ÂèéÁõäÊßãÈÄ†ÊØîËºÉ -->
        <div class="financial-card">
            <h6>
                <i class="fas fa-chart-pie text-primary me-2"></i>
                ÂèéÁõäÊßãÈÄ†ÊØîËºÉÔºàÊúÄÊñ∞Âπ¥Â∫¶Ôºâ
            </h6>
            {% for stock_data in stocks %}
            <div class="metric-comparison-row">
                <div class="metric-name">{{ stock_data.stock.code }}</div>
                <div class="metric-values">
                    <div class="metric-value-item">
                        <div class="metric-value-number text-primary">
                            {% if stock_data.latest_financial.revenue %}
                            {{ stock_data.latest_financial.revenue|floatformat:0 }}ÂÑÑ
                            {% else %}
                            -
                            {% endif %}
                        </div>
                        <div class="metric-value-label">Â£≤‰∏äÈ´ò</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number text-success">
                            {% if stock_data.latest_financial.operating_income %}
                            {{ stock_data.latest_financial.operating_income|floatformat:0 }}ÂÑÑ
                            {% else %}
                            -
                            {% endif %}
                        </div>
                        <div class="metric-value-label">Âñ∂Ê•≠Âà©Áõä</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number text-warning">
                            {% if stock_data.latest_financial.net_income %}
                            {{ stock_data.latest_financial.net_income|floatformat:0 }}ÂÑÑ
                            {% else %}
                            -
                            {% endif %}
                        </div>
                        <div class="metric-value-label">Á¥îÂà©Áõä</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ÂÆâÂÖ®ÊÄßÊØîËºÉ -->
        <div class="financial-card">
            <h6>
                <i class="fas fa-shield-alt text-success me-2"></i>
                ÂÆâÂÖ®ÊÄßÊåáÊ®ôÊØîËºÉ
            </h6>
            {% for stock_data in stocks %}
            <div class="metric-comparison-row">
                <div class="metric-name">{{ stock_data.stock.code }}</div>
                <div class="metric-values">
                    <div class="metric-value-item">
                        <div class="metric-value-number {% if stock_data.equity_ratio %}{% if stock_data.equity_ratio > 50 %}text-success{% elif stock_data.equity_ratio < 30 %}text-danger{% endif %}{% endif %}">
                            {{ stock_data.equity_ratio|floatformat:1|default:"-" }}%
                        </div>
                        <div class="metric-value-label">Ëá™Â∑±Ë≥áÊú¨ÊØîÁéá</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number {% if stock_data.current_ratio %}{% if stock_data.current_ratio > 1.5 %}text-success{% elif stock_data.current_ratio < 1 %}text-danger{% endif %}{% endif %}">
                            {{ stock_data.current_ratio|floatformat:2|default:"-" }}
                        </div>
                        <div class="metric-value-label">ÊµÅÂãïÊØîÁéá</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number {% if stock_data.debt_ratio %}{% if stock_data.debt_ratio < 0.3 %}text-success{% elif stock_data.debt_ratio > 0.7 %}text-danger{% endif %}{% endif %}">
                            {{ stock_data.debt_ratio|floatformat:2|default:"-" }}
                        </div>
                        <div class="metric-value-label">D/E„É¨„Ç∑„Ç™</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- ÊàêÈï∑ÊÄßÊØîËºÉ -->
        <div class="financial-card">
            <h6>
                <i class="fas fa-rocket text-info me-2"></i>
                ÊàêÈï∑ÊÄßÊåáÊ®ôÊØîËºÉ
            </h6>
            {% for stock_data in stocks %}
            <div class="metric-comparison-row">
                <div class="metric-name">{{ stock_data.stock.code }}</div>
                <div class="metric-values">
                    <div class="metric-value-item">
                        <div class="metric-value-number {% if stock_data.revenue_growth %}{% if stock_data.revenue_growth > 10 %}text-success{% elif stock_data.revenue_growth < 0 %}text-danger{% endif %}{% endif %}">
                            {{ stock_data.revenue_growth|floatformat:1|default:"-" }}%
                        </div>
                        <div class="metric-value-label">Â£≤‰∏äÊàêÈï∑Áéá</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number {% if stock_data.profit_growth %}{% if stock_data.profit_growth > 15 %}text-success{% elif stock_data.profit_growth < 0 %}text-danger{% endif %}{% endif %}">
                            {{ stock_data.profit_growth|floatformat:1|default:"-" }}%
                        </div>
                        <div class="metric-value-label">Âà©ÁõäÊàêÈï∑Áéá</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number text-info">
                            {{ stock_data.consecutive_years|default:"-" }}Âπ¥
                        </div>
                        <div class="metric-value-label">ÈÄ£Á∂öÂ¢óÁõä</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Â∏ÇÂ†¥Ë©ï‰æ°ÊØîËºÉ -->
        <div class="financial-card">
            <h6>
                <i class="fas fa-star text-warning me-2"></i>
                Â∏ÇÂ†¥Ë©ï‰æ°ÊØîËºÉ
            </h6>
            {% for stock_data in stocks %}
            <div class="metric-comparison-row">
                <div class="metric-name">{{ stock_data.stock.code }}</div>
                <div class="metric-values">
                    <div class="metric-value-item">
                        <div class="metric-value-number text-primary">
                            {{ stock_data.total_score }}
                        </div>
                        <div class="metric-value-label">Á∑èÂêà„Çπ„Ç≥„Ç¢</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number text-success">
                            {{ stock_data.valuation_score }}
                        </div>
                        <div class="metric-value-label">„Éê„É™„É•„Éº</div>
                    </div>
                    <div class="metric-value-item">
                        <div class="metric-value-number text-info">
                            {{ stock_data.growth_score }}
                        </div>
                        <div class="metric-value-label">ÊàêÈï∑ÊÄß</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- ÂàÜÊûê„Çµ„Éû„É™„Éº -->
    <div class="analysis-summary">
        <h5>
            <i class="fas fa-brain text-primary me-2"></i>
            AIÂàÜÊûê„Çµ„Éû„É™„Éº
        </h5>
        
        <div id="analysis-content">
            <div class="recommendation-card">
                <h6 class="text-success mb-2">
                    <i class="fas fa-thumbs-up me-1"></i>
                    ÊúÄÂÑ™ÁßÄÈäòÊüÑ
                </h6>
                <p class="mb-0">
                    <strong>{{ best_stock.stock.code }} - {{ best_stock.stock.name }}</strong><br>
                    Á∑èÂêà„Çπ„Ç≥„Ç¢ {{ best_stock.total_score }}ÁÇπ„ÅßÈ¶ñ‰Ωç„ÄÇÁâπ„Å´{{ best_stock.strength_area }}„Å´ÂÑ™„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ
                </p>
            </div>
            
            {% if investment_recommendations %}
            {% for rec in investment_recommendations %}
            <div class="recommendation-card {% if rec.risk_level == 'high' %}danger{% elif rec.risk_level == 'medium' %}warning{% endif %}">
                <h6 class="mb-2">
                    <i class="fas fa-lightbulb me-1"></i>
                    {{ rec.title }}
                </h6>
                <p class="mb-0">{{ rec.description }}</p>
            </div>
            {% endfor %}
            {% endif %}
        </div>
    </div>

    <!-- „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥ -->
    <div class="export-controls">
        <h6 class="mb-3">
            <i class="fas fa-download text-primary me-2"></i>
            „Ç®„ÇØ„Çπ„Éù„Éº„Éà„Éª„Ç¢„ÇØ„Ç∑„Éß„É≥
        </h6>
        <div class="d-flex justify-content-center gap-3 flex-wrap">
            <a href="/comparison/export/csv/?stocks={{ stock_codes }}" class="btn btn-outline-primary">
                <i class="fas fa-file-csv me-1"></i>CSVÂá∫Âäõ
            </a>
            <a href="/comparison/export/pdf/?stocks={{ stock_codes }}" class="btn btn-outline-secondary">
                <i class="fas fa-file-pdf me-1"></i>PDFÂá∫Âäõ
            </a>
            <button class="btn btn-outline-info" onclick="shareComparison()">
                <i class="fas fa-share me-1"></i>ÊØîËºÉÁµêÊûú„Çí„Ç∑„Çß„Ç¢
            </button>
            <button class="btn btn-outline-success" onclick="saveToWatchlist()">
                <i class="fas fa-star me-1"></i>„Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà„Å´‰øùÂ≠ò
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
let comparisonChart;
let currentChartType = 'performance';
let chartColors = ['#667eea', '#764ba2', '#28a745', '#dc3545', '#ffc107', '#17a2b8', '#6f42c1', '#e83e8c'];

// „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    initializeChart();
    assignColorsToStocks();
    updateComparisonChart();
});

// „ÉÅ„É£„Éº„ÉàÂàùÊúüÂåñ
function initializeChart() {
    const ctx = document.getElementById('comparison-chart').getContext('2d');
    
    comparisonChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: []
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            }
        }
    });
}

// ÈäòÊüÑ„Å´Ëâ≤„ÇíÂâ≤„ÇäÂΩì„Å¶
function assignColorsToStocks() {
    const stockCards = document.querySelectorAll('[data-stock-code]');
    stockCards.forEach((card, index) => {
        const color = chartColors[index % chartColors.length];
        card.style.setProperty('--stock-color', color);
        
        // „Ç´„Éº„Éâ„ÅÆÂ∑¶„Éú„Éº„ÉÄ„Éº„Å´Ëâ≤„ÇíÈÅ©Áî®
        const stockCard = card.querySelector('.stock-card');
        if (stockCard) {
            stockCard.style.borderLeftColor = color;
        }
    });
}

// „ÉÅ„É£„Éº„ÉàÂàá„ÇäÊõø„Åà
function switchChart(chartType) {
    // „Çø„Éñ„ÅÆÁä∂ÊÖãÊõ¥Êñ∞
    document.querySelectorAll('.chart-tab').forEach(tab => {
        tab.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentChartType = chartType;
    updateComparisonChart();
}

// „ÉÅ„É£„Éº„Éà„Éá„Éº„ÇøÊõ¥Êñ∞
function updateComparisonChart() {
    const loadingElement = document.getElementById('chart-loading');
    loadingElement.style.display = 'flex';
    
    // ÈäòÊüÑ„Éá„Éº„Çø„ÇíÂèñÂæó
    const stockCodes = Array.from(document.querySelectorAll('[data-stock-code]')).map(el => 
        el.getAttribute('data-stock-code')
    );
    
    setTimeout(() => {
        try {
            switch(currentChartType) {
                case 'performance':
                    updatePerformanceChart(stockCodes);
                    break;
                case 'valuation':
                    updateValuationChart(stockCodes);
                    break;
                case 'profitability':
                    updateProfitabilityChart(stockCodes);
                    break;
                case 'radar':
                    updateRadarChart(stockCodes);
                    break;
            }
        } catch (error) {
            console.error('„ÉÅ„É£„Éº„ÉàÊõ¥Êñ∞„Ç®„É©„Éº:', error);
        } finally {
            loadingElement.style.display = 'none';
        }
    }, 500);
}

// „Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÉÅ„É£„Éº„Éà
function updatePerformanceChart(stockCodes) {
    // ‰ªÆÊÉ≥ÁöÑ„Å™„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø
    const labels = ['1Êó•', '1ÈÄ±Èñì', '1„É∂Êúà', '3„É∂Êúà', '6„É∂Êúà', '1Âπ¥'];
    const datasets = [];
    
    stockCodes.forEach((code, index) => {
        // „É©„É≥„ÉÄ„É†„Å™„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Éá„Éº„Çø„ÇíÁîüÊàê
        const performance = Array.from({length: 6}, () => 
            (Math.random() - 0.5) * 20  // -10% to +10%
        );
        
        datasets.push({
            label: `${code}`,
            data: performance,
            borderColor: chartColors[index % chartColors.length],
            backgroundColor: chartColors[index % chartColors.length] + '20',
            borderWidth: 2,
            fill: false,
            tension: 0.2
        });
    });
    
    comparisonChart.config.type = 'line';
    comparisonChart.data.labels = labels;
    comparisonChart.data.datasets = datasets;
    comparisonChart.options.scales.y.title = { display: true, text: 'ÂèéÁõäÁéá (%)' };
    comparisonChart.update();
}

// „Éê„É™„É•„Ç®„Éº„Ç∑„Éß„É≥„ÉÅ„É£„Éº„Éà
function updateValuationChart(stockCodes) {
    const labels = stockCodes;
    const datasets = [
        {
            label: 'PER',
            data: getMetricData(stockCodes, 'per'),
            backgroundColor: chartColors[0] + '80',
            borderColor: chartColors[0],
            borderWidth: 2
        },
        {
            label: 'PBR',
            data: getMetricData(stockCodes, 'pbr'),
            backgroundColor: chartColors[1] + '80',
            borderColor: chartColors[1],
            borderWidth: 2
        }
    ];
    
    comparisonChart.config.type = 'bar';
    comparisonChart.data.labels = labels;
    comparisonChart.data.datasets = datasets;
    comparisonChart.options.scales.y.title = { display: true, text: 'ÂÄçÁéá' };
    comparisonChart.update();
}

// ÂèéÁõäÊÄß„ÉÅ„É£„Éº„Éà
function updateProfitabilityChart(stockCodes) {
    const labels = stockCodes;
    const datasets = [
        {
            label: 'ROE (%)',
            data: getMetricData(stockCodes, 'roe'),
            backgroundColor: chartColors[2] + '80',
            borderColor: chartColors[2],
            borderWidth: 2
        },
        {
            label: 'ROA (%)',
            data: getMetricData(stockCodes, 'roa'),
            backgroundColor: chartColors[3] + '80',
            borderColor: chartColors[3],
            borderWidth: 2
        }
    ];
    
    comparisonChart.config.type = 'bar';
    comparisonChart.data.labels = labels;
    comparisonChart.data.datasets = datasets;
    comparisonChart.options.scales.y.title = { display: true, text: 'Âà©ÁõäÁéá (%)' };
    comparisonChart.update();
}

// „É¨„Éº„ÉÄ„Éº„ÉÅ„É£„Éº„Éà
function updateRadarChart(stockCodes) {
    const datasets = [];
    
    stockCodes.forEach((code, index) => {
        // ÂêÑÈäòÊüÑ„ÅÆ„Çπ„Ç≥„Ç¢„Éá„Éº„Çø„ÇíÂèñÂæó
        const scoreData = getStockScoreData(code);
        
        datasets.push({
            label: code,
            data: [
                scoreData.valuation || 0,
                scoreData.profitability || 0,
                scoreData.growth || 0,
                scoreData.safety || 0,
                scoreData.dividend || 0
            ],
            borderColor: chartColors[index % chartColors.length],
            backgroundColor: chartColors[index % chartColors.length] + '20',
            borderWidth: 2,
            pointBackgroundColor: chartColors[index % chartColors.length],
            pointBorderColor: '#fff',
            pointHoverBackgroundColor: '#fff',
            pointHoverBorderColor: chartColors[index % chartColors.length]
        });
    });
    
    comparisonChart.config.type = 'radar';
    comparisonChart.data.labels = ['„Éê„É™„É•„Ç®„Éº„Ç∑„Éß„É≥', 'ÂèéÁõäÊÄß', 'ÊàêÈï∑ÊÄß', 'ÂÆâÂÖ®ÊÄß', 'ÈÖçÂΩì'];
    comparisonChart.data.datasets = datasets;
    comparisonChart.options.scales = {
        r: {
            beginAtZero: true,
            max: 25,
            ticks: {
                stepSize: 5
            }
        }
    };
    comparisonChart.update();
}

// ÊåáÊ®ô„Éá„Éº„ÇøÂèñÂæóÔºàÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
function getMetricData(stockCodes, metric) {
    return stockCodes.map(code => {
        // DOM„Åã„ÇâÂÆüÈöõ„ÅÆÂÄ§„ÇíÂèñÂæó
        const stockCard = document.querySelector(`[data-stock-code="${code}"]`);
        if (!stockCard) return 0;
        
        // „É°„Éà„É™„ÇØ„Çπ„Å´Âøú„Åò„ÅüÂÄ§„ÇíÂèñÂæóÔºàÂÆüË£Ö„Åß„ÅØÂÆüÈöõ„ÅÆ„Éá„Éº„Çø„Çí‰ΩøÁî®Ôºâ
        switch(metric) {
            case 'per':
                return Math.random() * 30 + 5; // 5-35„ÅÆÁØÑÂõ≤
            case 'pbr':
                return Math.random() * 3 + 0.5; // 0.5-3.5„ÅÆÁØÑÂõ≤
            case 'roe':
                return Math.random() * 25 + 5; // 5-30„ÅÆÁØÑÂõ≤
            case 'roa':
                return Math.random() * 15 + 2; // 2-17„ÅÆÁØÑÂõ≤
            default:
                return 0;
        }
    });
}

// ÈäòÊüÑ„Çπ„Ç≥„Ç¢„Éá„Éº„ÇøÂèñÂæó
function getStockScoreData(stockCode) {
    // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØDOM„Åæ„Åü„ÅØAPI„Åã„ÇâÂèñÂæó
    return {
        valuation: Math.random() * 25,
        profitability: Math.random() * 25,
        growth: Math.random() * 25,
        safety: Math.random() * 25,
        dividend: Math.random() * 25
    };
}

// ÈäòÊüÑËøΩÂä†
function addStockToComparison() {
    const stockCode = prompt('ËøΩÂä†„Åô„ÇãÈäòÊüÑ„Ç≥„Éº„Éâ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:');
    if (!stockCode) return;
    
    // ÁèæÂú®„ÅÆURL„Éë„É©„É°„Éº„Çø„ÇíÂèñÂæó
    const urlParams = new URLSearchParams(window.location.search);
    const currentStocks = urlParams.get('stocks') || '';
    
    // Êñ∞„Åó„ÅÑÈäòÊüÑ„Ç≥„Éº„Éâ„ÇíËøΩÂä†
    const stockList = currentStocks ? currentStocks.split(',') : [];
    if (!stockList.includes(stockCode.toUpperCase())) {
        stockList.push(stockCode.toUpperCase());
        urlParams.set('stocks', stockList.join(','));
        
        // „Éö„Éº„Ç∏„ÇíÂÜçË™≠„ÅøËæº„Åø
        window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
    } else {
        showNotification('„Åì„ÅÆÈäòÊüÑ„ÅØÊó¢„Å´ÊØîËºÉ„Å´Âê´„Åæ„Çå„Å¶„ÅÑ„Åæ„Åô', 'warning');
    }
}

// ÈäòÊüÑÈô§Âéª
function removeStockFromComparison(stockCode) {
    if (confirm(`${stockCode}„ÇíÊØîËºÉ„Åã„ÇâÈô§Â§ñ„Åó„Åæ„Åô„ÅãÔºü`)) {
        const urlParams = new URLSearchParams(window.location.search);
        const currentStocks = urlParams.get('stocks') || '';
        
        const stockList = currentStocks.split(',').filter(code => code !== stockCode);
        
        if (stockList.length === 0) {
            // ÂÖ®„Å¶„ÅÆÈäòÊüÑ„ÅåÈô§Â§ñ„Åï„Çå„ÅüÂ†¥Âêà„ÅØ„Çπ„ÇØ„É™„Éº„Éã„É≥„Ç∞„Éö„Éº„Ç∏„Å´Êàª„Çã
            window.location.href = '{% url "stock:screening" %}';
        } else {
            urlParams.set('stocks', stockList.join(','));
            window.location.href = `${window.location.pathname}?${urlParams.toString()}`;
        }
    }
}

// ÊØîËºÉ„Éá„Éº„ÇøÊõ¥Êñ∞
function refreshComparison() {
    showNotification('„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Å¶„ÅÑ„Åæ„Åô...', 'info');
    
    // „É≠„Éº„Éá„Ç£„É≥„Ç∞Ë°®Á§∫
    document.querySelectorAll('.stock-card').forEach(card => {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.innerHTML = '<div class="loading-spinner"></div>';
        card.style.position = 'relative';
        card.appendChild(overlay);
    });
    
    // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØÊñ∞„Åó„ÅÑ„Éá„Éº„Çø„ÇíÂèñÂæó
    setTimeout(() => {
        document.querySelectorAll('.loading-overlay').forEach(overlay => {
            overlay.remove();
        });
        
        document.getElementById('last-update').textContent = new Date().toLocaleString('ja-JP');
        updateComparisonChart();
        showNotification('„Éá„Éº„Çø„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success');
    }, 2000);
}

// ÊØîËºÉÁµêÊûú„ÅÆ„Ç∑„Çß„Ç¢
function shareComparison() {
    const urlParams = new URLSearchParams(window.location.search);
    const shareUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
    
    if (navigator.share) {
        navigator.share({
            title: 'ÈäòÊüÑÊØîËºÉÂàÜÊûê',
            text: 'ÊäïË≥áÈäòÊüÑ„ÅÆË©≥Á¥∞ÊØîËºÉÁµêÊûú„Çí„ÅîË¶ß„Åè„Å†„Åï„ÅÑ',
            url: shareUrl
        });
    } else {
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: URL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº
        navigator.clipboard.writeText(shareUrl).then(() => {
            showNotification('ÊØîËºÉURL„Çí„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü', 'success');
        }).catch(() => {
            // „Åï„Çâ„Å™„Çã„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
            prompt('‰ª•‰∏ã„ÅÆURL„Çí„Ç≥„Éî„Éº„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', shareUrl);
        });
    }
}

// „Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà„Å´‰øùÂ≠ò
function saveToWatchlist() {
    const urlParams = new URLSearchParams(window.location.search);
    const stocks = urlParams.get('stocks') || '';
    
    if (!stocks) {
        showNotification('‰øùÂ≠ò„Åô„ÇãÈäòÊüÑ„Åå„ÅÇ„Çä„Åæ„Åõ„Çì', 'warning');
        return;
    }
    
    const watchlistName = prompt('„Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', `ÊØîËºÉÂàÜÊûê_${new Date().toLocaleDateString()}`);
    if (!watchlistName) return;
    
    // ÂÆüÈöõ„ÅÆÂÆüË£Ö„Åß„ÅØAPI„Å´ÈÄÅ‰ø°
    fetch('/api/watchlist/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]')?.value || ''
        },
        body: JSON.stringify({
            name: watchlistName,
            stocks: stocks.split(',')
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification(`„Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà„Äå${watchlistName}„Äç„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü`, 'success');
        } else {
            showNotification('„Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('„Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà‰ΩúÊàê„Ç®„É©„Éº:', error);
        showNotification('„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error');
    });
}

// ÈÄöÁü•Ë°®Á§∫ÔºàÂÖ±ÈÄöÈñ¢Êï∞Ôºâ
function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-info-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // 4ÁßíÂæå„Å´Ëá™ÂãïÂâäÈô§
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 4000);
}

// „Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„Éà
document.addEventListener('keydown', function(e) {
    // Ctrl+A „ÅßÈäòÊüÑËøΩÂä†
    if (e.ctrlKey && e.key === 'a') {
        e.preventDefault();
        addStockToComparison();
    }
    
    // Ctrl+R „ÅßÊõ¥Êñ∞
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        refreshComparison();
    }
    
    // Ctrl+S „Åß„Ç¶„Ç©„ÉÉ„ÉÅ„É™„Çπ„Éà‰øùÂ≠ò
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        saveToWatchlist();
    }
});

// „ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóÂàùÊúüÂåñ
document.addEventListener('DOMContentLoaded', function() {
    // Bootstrap tooltip„ÅÆÂàùÊúüÂåñ
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

console.log('ÈäòÊüÑÊØîËºÉ„Éö„Éº„Ç∏ÂàùÊúüÂåñÂÆå‰∫Ü');
</script>
{% endblock %}